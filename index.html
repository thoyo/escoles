<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaflet Map with Results</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <style>
        /* Layout Styles */
        body {
            margin: 0;
            display: flex;
            flex-direction: row; /* Default for horizontal screens */
            height: 100vh;
        }

        /* Adjust layout for vertical screens */
        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }
        }

        #map {
            flex: 2; /* Occupies two-thirds of the screen */
            height: 100%;
        }

        #results {
            flex: 1; /* Occupies one-third of the screen */
            overflow-y: auto;
            padding: 10px;
            box-shadow: -2px 0 5px rgba(0, 0, 0, 0.1);
            background: #f8f9fa;
        }

        .result-item {
            border-bottom: 1px solid #ddd;
            padding: 10px 0;
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .result-title {
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="results">
        <div id="result-list">Fes click al mapa per veure els centres educatius de proximitat a un domicili (3-12 anys) a la ciutat de Barcelona</div>
    </div>

    <script>
        // Initialize the map
        const map = L.map('map').setView([41.3879, 2.16992], 14);

        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 18,
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        // Variables to store active markers, radius circle, area, and home marker
        let activeMarkers = [];
        let activeCircle = null;
        let activeArea = null;
        let homeMarker = null;

        const resultList = document.getElementById('result-list'); // Reference to the result list container

        // Define a custom home icon
        const homeIcon = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/69/69524.png',
            iconSize: [32, 32],
            iconAnchor: [16, 32],
            popupAnchor: [0, -32]
        });

        // Function to clear all active markers, radius circle, area, home marker, and result list
        function clearMap() {
            activeMarkers.forEach(marker => map.removeLayer(marker));
            activeMarkers = [];
            if (activeCircle) {
                map.removeLayer(activeCircle);
                activeCircle = null;
            }
            if (activeArea) {
                map.removeLayer(activeArea);
                activeArea = null;
            }
            if (homeMarker) {
                map.removeLayer(homeMarker);
                homeMarker = null;
            }
            resultList.innerHTML = '<p>No results found.</p>'; // Clear result list
        }

        // Function to fetch and display nearby markers
        function fetchAndDisplayNearbyMarkers(lat, lng) {
            const radius = 500; // Radius in meters
            fetch(`/nearby?lat=${lat}&lng=${lng}&radius=${radius}`)
                .then(response => response.json())
                .then(data => {
                    resultList.innerHTML = ''; // Clear the previous results

                    // Draw the 500m radius circle
                    activeCircle = L.circle([lat, lng], {
                        color: 'blue',
                        fillColor: '#a3c9ff',
                        fillOpacity: 0.3,
                        radius: radius
                    }).addTo(map);

                    // Draw the detected area if any
                    if (data.area) {
                        const areaCoords = data.area.geometry.coordinates;
                        activeArea = L.geoJSON(data.area, {
                            style: { color: 'purple', fillOpacity: 0.2 }
                        }).addTo(map);
                    }

                    // Add markers for each feature returned by the backend
                    data.features.forEach(feature => {
                        const coords = feature.geometry.coordinates;
                        const titularitat = feature.properties["nom_titularitat"];

                        // Determine marker color
                        const markerColor = titularitat === "Departament d'Educació" ? "blue" : "green";

                        // Create a marker with the color-coded icon
                        const marker = L.circleMarker([coords[1], coords[0]], {
                            radius: 8,
                            fillColor: markerColor,
                            color: markerColor,
                            weight: 1,
                            fillOpacity: 0.8
                        })
                        .bindPopup(`
                            <strong>${feature.properties["denominaci_completa"]}</strong><br>
                            Titularitat: ${titularitat || "Unknown"}<br>
                            Adreça: ${feature.properties["adre_a"]}
                        `);

                        marker.addTo(map);
                        activeMarkers.push(marker);

                        // Add to the results list
                        const resultItem = document.createElement('div');
                        resultItem.className = 'result-item';
                        resultItem.innerHTML = `
                            <div class="result-title">${feature.properties["denominaci_completa"]}</div>
                            <div>Titularitat: ${titularitat || "Unknown"}</div>
                            <div>Adreça: ${feature.properties["adre_a"]}</div>
                        `;

                        // Center map on marker when result item is clicked
                        resultItem.addEventListener('click', () => {
                            map.setView([coords[1], coords[0]], 15);
                            marker.openPopup();
                        });

                        resultList.appendChild(resultItem);
                    });

                    // If no features found, show a message
                    if (!data.features.length) {
                        resultList.innerHTML = '<p>No results found.</p>';
                    }
                });
        }

        // Handle map click event
        map.on('click', function (e) {
            const { lat, lng } = e.latlng;

            clearMap(); // Clear existing markers, radius circle, area, and home marker

            // Place a home marker at the clicked location
            homeMarker = L.marker([lat, lng], { icon: homeIcon })
                .addTo(map);

            // Fetch and display nearby markers
            fetchAndDisplayNearbyMarkers(lat, lng);
        });
    </script>
</body>
</html>
