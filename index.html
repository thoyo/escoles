<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cercador d'escoles properes al domicili</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <!-- Add Chart.js -->
    <style>
        /* Layout Styles */
        body {
            margin: 0;
            display: flex;
            flex-direction: row; /* Default for horizontal screens */
            height: 100vh;
        }

        /* Adjust layout for vertical screens */
        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }
        }

        #map {
            flex: 2; /* Occupies two-thirds of the screen */
            height: 100%;
        }

        #results {
            flex: 1; /* Occupies one-third of the screen */
            display: flex;
            flex-direction: column;
            box-shadow: -2px 0 5px rgba(0, 0, 0, 0.1);
            background: #f8f9fa;
            height: 100%; /* Ensures it fills the height */
        }

        #result-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            min-height: 0; /* Prevent shrinking issues */
        }

        #footer {
            padding: 10px;
            background: #e9ecef;
            border-top: 1px solid #ddd;
            text-align: center;
            font-size: 0.9em;
            color: #555;
            flex-shrink: 0; /* Ensure footer does not shrink */
        }

        .result-item {
            border-bottom: 1px solid #ddd;
            padding: 10px 0;
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .result-title {
            font-weight: bold;
        }

        .selected {
            background-color: #e9ecef;  /* Light background color for selected item */
            opacity: 0.7;  /* Slightly dim the opacity */
        }

        /* Ensure the map remains visible on vertical screens */
        @media (max-width: 768px) {
            #map {
                min-height: 50vh; /* Adjust the value as needed */
            }
        }

        /* Styling for the chart */
        #chart-container {
            height: 300px; /* Set height of the chart */
            width: 100%;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="results">
        <!-- Filter Section -->
        <div id="filters" style="margin-bottom: 10px;">
            <label>
                <input type="checkbox" id="filter-publics" checked> Públics
            </label>
            <label style="margin-left: 10px;">
                <input type="checkbox" id="filter-concertats" checked> Concertats
            </label>
        </div>

        <!-- Results List -->
        <div id="result-list">
            Fes click al mapa per veure els centres educatius de proximitat a un domicili (3-12 anys) a la ciutat de Barcelona
        </div>

        <!-- Chart for remaining places -->
        <div id="chart-container">
            <canvas id="remainingPlacesChart"></canvas>
        </div>

        <div id="footer">
            Aquesta web mostra els centres educatius (3-12 anys) més propers a un domicili a la ciutat de Barcelona, per als quals s'obtindria la màxima puntuació en la sol·licitud de places. <br>
            Els resultats son aproximats --> <a href="https://www.edubcn.cat/ca/alumnat_i_familia/informacio_general_matriculacio/arees_influencia/consulta_de_centres_educatius#/cerca">Font oficial</a> <br>
            <a href="https://docs.google.com/forms/d/e/1FAIpQLSfljeyu6oEJ_nKNj2SNqEBe_wEvju3hNm5PY_HbxNMPRLvmZg/viewform?usp=header">Comparteix el teu feedback!</a>
        </div>
    </div>

    <script>
        // Initialize the map
        const map = L.map('map').setView([41.3879, 2.16992], 14);

        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 18,
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        // Variables to store active markers, radius circle, area, home marker
        let activeMarkers = [];
        let activeCircle = null;
        let activeArea = null;
        let homeMarker = null;

        const resultList = document.getElementById('result-list'); // Reference to the result list container

        // Define a custom home icon
        const homeIcon = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/69/69524.png',
            iconSize: [32, 32],
            iconAnchor: [16, 32],
            popupAnchor: [0, -32]
        });

        // Function to clear all active markers, radius circle, area, home marker, and result list
        function clearMap() {
            activeMarkers.forEach(marker => map.removeLayer(marker));
            activeMarkers = [];
            if (activeCircle) {
                map.removeLayer(activeCircle);
                activeCircle = null;
            }
            if (activeArea) {
                map.removeLayer(activeArea);
                activeArea = null;
            }
            if (homeMarker) {
                map.removeLayer(homeMarker);
                homeMarker = null;
            }
            resultList.innerHTML = '<p>No results found.</p>'; // Clear result list
        }

        let currentChart = null;  // Variable to store the current chart instance
        let allPlots = [];  // Store plots for all items

        // Function to display all plots
        function displayAllPlots(remainingPlacesData, features) {
            const ctx = document.getElementById('remainingPlacesChart').getContext('2d');

            // Destroy the current chart if it exists
            if (currentChart) {
                currentChart.destroy();
            }

            const dates = remainingPlacesData[0].map(item => item[0]); // Assuming same dates for all features
            const datasets = features.map((feature, index) => ({
                label: feature.properties["denominaci_completa"],
                data: remainingPlacesData[index].map(item => item[1]),
                borderColor: `rgb(${(index * 60) % 255}, ${(index * 100) % 255}, ${(index * 150) % 255})`,
                fill: false,
            }));

            // Create a new chart with all plots
            currentChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            type: 'category',
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Places vacants'
                            },
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Get random color for each dataset
        function getRandomColor() {
            const letters = '0123456789ABCDEF';
            let color = '#';
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        // Function to handle item click and toggle visibility of the plot for that item
        function handleItemClick(index) {
            // Toggle visibility for the selected plot
            const dataset = currentChart.data.datasets[index];
            dataset.hidden = !dataset.hidden;  // Toggle visibility

            // If the dataset is hidden, only show the selected plot, otherwise show all plots
            if (dataset.hidden) {
                // Hide all other plots
                currentChart.data.datasets.forEach((data, idx) => {
                    if (idx !== index) {
                        data.hidden = true;
                    }
                });
            } else {
                // Show all plots
                currentChart.data.datasets.forEach((data, idx) => {
                    data.hidden = false;
                });
            }

            // Update the chart
            currentChart.update();
        }

        function fetchAndDisplayNearbyMarkers(lat, lng) {
            const radius = 500; // Radius in meters
            fetch(`/projects/escoles/nearby?lat=${lat}&lng=${lng}&radius=${radius}`)
                .then(response => response.json())
                .then(data => {
                    resultList.innerHTML = ''; // Clear the previous results

                    // Draw the 500m radius circle
                    activeCircle = L.circle([lat, lng], {
                        color: 'blue',
                        fillColor: '#a3c9ff',
                        fillOpacity: 0.3,
                        radius: radius
                    }).addTo(map);

                    // Draw the detected area if any
                    if (data.area) {
                        activeArea = L.geoJSON(data.area, {
                            style: { color: 'purple', fillOpacity: 0.2 }
                        }).addTo(map);
                    }

                    const sortedFeatures = data.features.sort(
                        (a, b) => a.properties.distance_to_home - b.properties.distance_to_home
                    );

                    // Function to filter and display results based on checkboxes
                    let currentlySelectedItem = null;  // Variable to track the currently selected item

                    let allPlotsDisplayed = true;  // Set this to true to show all plots initially

                    function filterResults() {
                        const showPublics = document.getElementById('filter-publics').checked;
                        const showConcertats = document.getElementById('filter-concertats').checked;

                        // Clear the map and the list
                        activeMarkers.forEach(marker => map.removeLayer(marker));
                        activeMarkers = [];
                        resultList.innerHTML = '';

                        // Filter the features and prepare the list
                        const filteredFeatures = sortedFeatures.filter(feature => {
                            const naturalesa = feature.properties["nom_naturalesa"];
                            const isPublic = naturalesa === "Públic";
                            return (isPublic && showPublics) || (!isPublic && showConcertats);
                        });

                        // Re-add filtered markers and items to the list
                        filteredFeatures.forEach(feature => {
                            const coords = feature.geometry.coordinates;
                            const titularitat = feature.properties["nom_titularitat"];
                            const naturalesa = feature.properties["nom_naturalesa"];
                            const distance = feature.properties["distance_to_home"]; // Get distance from backend

                            // Determine marker color
                            const markerColor = naturalesa === "Públic" ? "blue" : "green";

                            // Create a marker with the color-coded icon
                            const marker = L.circleMarker([coords[1], coords[0]], {
                                radius: 8,
                                fillColor: markerColor,
                                color: markerColor,
                                weight: 1,
                                fillOpacity: 0.8
                            })
                            .bindPopup(`
                                <strong>${feature.properties["denominaci_completa"]}</strong><br>
                                Distància a casa: ${distance.toFixed(2)} metres<br>
                                Adreça: <a href="${feature.properties["adre_a_maps"]}"
                                          target="_blank"
                                          rel="noopener noreferrer">
                                          ${feature.properties["adre_a"]}
                                        </a><br>
                                Districte: ${feature.properties["nom_dm"]}<br>
                                Web: ${feature.properties["url"]}<br>
                                Email: ${feature.properties["e_mail_centre"]}<br>
                                Telèfon: ${feature.properties["tel_fon_centre"]}<br>
                                Tipus: ${feature.properties["nom_naturalesa"]}<br>
                                Titularitat: ${titularitat || "Unknown"}<br>
                            `);

                            marker.addTo(map);
                            activeMarkers.push(marker);

                            // Add to the results list
                            const resultItem = document.createElement('div');
                            resultItem.className = 'result-item';
                            resultItem.innerHTML = `
                                <div class="result-title">${feature.properties["denominaci_completa"]}</div>
                                <div>Distància a casa: ${distance.toFixed(2)} metres</div>
                                <div>Places ofertades el darrer any: ${feature.properties["total_places"]}</div>
                                <div>
                                    Adreça:
                                    <a href="${feature.properties["adre_a_maps"]}"
                                       target="_blank"
                                       rel="noopener noreferrer">
                                       ${feature.properties["adre_a"]}
                                    </a>
                                </div>
                                <div>Districte: ${feature.properties["nom_dm"]}</div>
                                <div>
                                    Web:
                                    <a href="${feature.properties["url"]}"
                                       target="_blank"
                                       rel="noopener noreferrer">
                                       ${feature.properties["url"]}
                                    </a>
                                </div>
                                <div>Email: ${feature.properties["e_mail_centre"]}</div>
                                <div>Telèfon: ${feature.properties["tel_fon_centre"]}</div>
                                <div>Tipus: ${feature.properties["nom_naturalesa"]}</div>
                                <div>Titularitat: ${titularitat || "Unknown"}</div>
                            `;

                            // Handle item selection or unselection
                            resultItem.addEventListener('click', () => {
                                if (currentlySelectedItem === resultItem) {
                                    // If the item is already selected, unselect it
                                    resultItem.classList.remove('selected');
                                    currentlySelectedItem = null;

                                    // Show all plots again
                                    displayAllPlots(filteredFeatures.map(feature => feature.properties.remaining_places), filteredFeatures);
                                    allPlotsDisplayed = true;

                                    // Deselect on the map
                                    activeMarkers.forEach(marker => marker.setStyle({ opacity: 1 }));

                                } else {
                                    // If this item is not selected, select it
                                    if (currentlySelectedItem) {
                                        // Deselect the previous item
                                        currentlySelectedItem.classList.remove('selected');
                                    }

                                    // Select the clicked item
                                    resultItem.classList.add('selected');
                                    currentlySelectedItem = resultItem;

                                    // Show only this item's plot
                                    displayChart(feature.properties["remaining_places"]);
                                    allPlotsDisplayed = false;

                                    // Highlight the item on the map by reducing opacity of others
                                    activeMarkers.forEach(marker => {
                                        if (marker !== resultItem.marker) {
                                            marker.setStyle({ opacity: 0.3 }); // Dim other markers
                                        }
                                    });
                                }

                                // Center map on marker when result item is clicked
                                map.setView([coords[1], coords[0]], 15);
                                marker.openPopup();
                            });

                            resultList.appendChild(resultItem);
                        });

                        // If no features match the filter, show a message
                        if (!resultList.children.length) {
                            resultList.innerHTML = '<p>No results found.</p>';
                        }

                        // Update the plots with filtered data
                        const remainingPlacesData = filteredFeatures.map(feature => feature.properties.remaining_places);

                        if (allPlotsDisplayed) {
                            displayAllPlots(remainingPlacesData, filteredFeatures);
                        }
                    }


                    // Attach event listeners to checkboxes
                    document.getElementById('filter-publics').addEventListener('change', filterResults);
                    document.getElementById('filter-concertats').addEventListener('change', filterResults);

                    // Initial render with filters applied
                    filterResults();
                });
        }

        function displayChart(remainingPlaces) {
            const ctx = document.getElementById('remainingPlacesChart').getContext('2d');

            // Destroy the current chart if it exists
            if (currentChart) {
                currentChart.destroy();
            }

            const dates = remainingPlaces.map(item => item[0]);
            const places = remainingPlaces.map(item => item[1]);

            // Create a new chart
            currentChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Places vacants',
                        data: places,
                        borderColor: 'rgb(75, 192, 192)',
                        fill: false,
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            type: 'category',
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Places vacants'
                            },
                            beginAtZero: true
                        }
                    }
                }
            });
        }



        // Handle map click event
        map.on('click', function (e) {
            const { lat, lng } = e.latlng;

            clearMap(); // Clear existing markers, radius circle, area, and home marker

            // Place a home marker at the clicked location
            homeMarker = L.marker([lat, lng], { icon: homeIcon })
                .addTo(map);

            // Fetch and display nearby markers
            fetchAndDisplayNearbyMarkers(lat, lng);
        });
    </script>
</body>
</html>


